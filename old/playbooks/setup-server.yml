---
- hosts: local_vm_servers
  become: true
  become_user: root
  tasks:
    - name: Clear motd directory
      shell: rm -f /etc/update-motd.d/*

    - name: Copy motd
      copy:
        src: ../templates/01-custom.j2
        dest: /etc/update-motd.d/01-custom
        owner: root
        group: root
        mode: '0755'
        
    - name: Set timezone to Pacific
      community.general.timezone:
        name: America/Los_Angeles

    - name: Set NTP to use the local NTP server
      copy:
        src: ../templates/timesyncd.conf.j2
        dest: /etc/systemd/timesyncd.conf
        owner: root
        group: root

    - name: Restart NTP service
      service:
        name: systemd-timesyncd
        state: restarted
        
    - name: Remove snapd 
      apt:
        name: snapd
        state: absent
        purge: yes
      when: ansible_distribution == "Ubuntu"

    - name: Remove snapd-related directories
      file:
        path: "{{ item }}"
        state: absent
      with_items:
        - /snap
        - /var/snap
        - /var/lib/snapd
        - $HOME/snap
      when: ansible_distribution == "Ubuntu"

    - name: Install qemu-guest-agent
      apt:
        name: qemu-guest-agent

